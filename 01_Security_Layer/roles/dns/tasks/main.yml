---
# roles/dns/tasks/main.yml
# Refactored to use Ansible Native Modules

- name: Install bind server packages
  dnf:
    name: [bind, bind-utils, firewalld]
    state: present

- name: Enable and start firewalld
  service:
    name: firewalld
    state: started
    enabled: yes

- name: Open DNS service (permanent)
  ansible.posix.firewalld:
    service: dns
    permanent: yes
    state: enabled
    immediate: yes

- name: Deploy named.conf
  template:
    src: named.conf.j2
    dest: /etc/named.conf
    owner: root
    group: named
    mode: "0640"
  notify: Restart named

- name: Ensure /var/named permissions
  file:
    path: /var/named
    owner: root
    group: named
    recurse: yes

- name: Create /var/named/data directory for logging
  file:
    path: /var/named/data
    state: directory
    owner: named
    group: named
    mode: '0770'

- name: Create zone files from dns_zones
  template:
    src: zone.j2
    dest: "/var/named/{{ item.zone }}.zone"
    owner: root
    group: named
    mode: "0640"
  loop: "{{ dns_zones }}"
  vars:
    zone_name: "{{ item.zone }}"
    records: "{{ item.records | default([]) }}"
    dns_ip: "{{ ansible_host | default(ansible_default_ipv4.address) }}"
    serial: "{{ lookup('pipe', 'date +%Y%m%d') }}01"
  notify: Restart named

- name: Restore SELinux context for zone files
  command: restorecon -Rv /var/named
  changed_when: false

- name: Validate named.conf
  command: named-checkconf /etc/named.conf
  changed_when: false

- name: Validate zone files
  command: "named-checkzone {{ item.zone }} /var/named/{{ item.zone }}.zone"
  loop: "{{ dns_zones }}"
  changed_when: false

- name: Enable and start named
  service:
    name: named
    state: started
    enabled: yes

- name: Verify named is active
  command: systemctl is-active named
  changed_when: false
  failed_when: false

- name: Verify named is listening on port 53
  shell: "ss -lntup | egrep ':53\\b|named'"
  changed_when: false
  failed_when: false

---
# roles/secure/tasks/main.yml
# Refactored to use Ansible Native Modules

- name: Install required packages
  dnf:
    name: [firewalld, iproute]
    state: present

- name: Enable and start firewalld
  service:
    name: firewalld
    state: started
    enabled: yes

- name: Persist sysctl settings for forwarding and rp_filter
  copy:
    dest: /etc/sysctl.d/99-pc1-secure.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      net.ipv4.ip_forward = 1
      net.ipv4.conf.all.rp_filter = 2
      net.ipv4.conf.default.rp_filter = 2
      net.ipv4.conf.{{ nic1_interface | default('ens160') }}.rp_filter = 2
      net.ipv4.conf.{{ nic2_interface | default('ens192') }}.rp_filter = 2
  notify: Apply sysctl

# Firewall Zone Assignment
- name: Ensure public interface is assigned to public zone
  ansible.posix.firewalld:
    zone: public
    interface: "{{ nic1_interface | default('ens160') }}"
    permanent: yes
    state: enabled
    immediate: yes

- name: Ensure private interface is assigned to trusted zone
  ansible.posix.firewalld:
    zone: trusted
    interface: "{{ nic2_interface | default('ens192') }}"
    permanent: yes
    state: enabled
    immediate: yes

# Trusted Zone Sources
- name: Trusted Zone - Allow Internal Network
  ansible.posix.firewalld:
    zone: trusted
    source: 10.2.2.0/24
    permanent: yes
    state: enabled
    immediate: yes

- name: Trusted Zone - Allow DB Network
  ansible.posix.firewalld:
    zone: trusted
    source: 10.2.3.0/24
    permanent: yes
    state: enabled
    immediate: yes

# Public Zone Services & Masquerade
- name: Enable masquerade on public zone
  ansible.posix.firewalld:
    zone: public
    masquerade: yes
    permanent: yes
    state: enabled
    immediate: yes

- name: Open HTTP/HTTPS service on public zone
  ansible.posix.firewalld:
    zone: public
    service: "{{ item }}"
    permanent: yes
    state: enabled
    immediate: yes
  loop: [http, https]

# Port Forwarding
- name: Add port forwarding rules
  ansible.posix.firewalld:
    zone: public
    port_forward:
      - port: "{{ item.port }}"
        proto: tcp
        toport: "{{ item.toport }}"
        toaddr: "{{ item.toaddr }}"
    permanent: yes
    state: enabled
    immediate: yes
  loop:
    - { port: 80,    toport: 80,    toaddr: "10.2.1.2" }
    - { port: 443,   toport: 443,   toaddr: "10.2.1.2" }
    
    - { port: 8080,  toport: 8080,  toaddr: "10.2.2.40" } # Jenkins
    - { port: 3001,  toport: 3001,  toaddr: "10.2.2.40" } # Gitea
    - { port: 5000,  toport: 5000,  toaddr: "10.2.2.40" } # Harbor
    
    - { port: 3000,  toport: 3000,  toaddr: "10.2.2.50" } # Grafana
    - { port: 9090,  toport: 9090,  toaddr: "10.2.2.50" } # Prometheus
    - { port: 9093,  toport: 9093,  toaddr: "10.2.2.50" } # Alertmanager
    
    - { port: 30080, toport: 30080, toaddr: "10.2.2.8" }
    - { port: 30090, toport: 30090, toaddr: "10.2.2.8" }
    
    # ArgoCD NodePort (Fixed: 32177 -> WN3)
    - { port: 32177, toport: 32177, toaddr: "10.2.2.7" }

    # [Option] Use Ingress VIP (High Availability)
    # - { port: 32177, toport: 32177, toaddr: "10.2.2.101" }


---
# roles/secure/tasks/main.yml
# Refactored to use Ansible Native Modules + Variables + Cleanup

- name: Install required packages
  dnf:
    name: [firewalld, iproute]
    state: present

- name: Enable and start firewalld
  service:
    name: firewalld
    state: started
    enabled: yes

- name: Persist sysctl settings for forwarding and rp_filter
  copy:
    dest: /etc/sysctl.d/99-pc1-secure.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      net.ipv4.ip_forward = 1
      net.ipv4.conf.all.rp_filter = {{ secure_rp_filter }}
      net.ipv4.conf.default.rp_filter = {{ secure_rp_filter }}
      net.ipv4.conf.{{ secure_public_if }}.rp_filter = {{ secure_rp_filter }}
      net.ipv4.conf.{{ secure_trusted_if }}.rp_filter = {{ secure_rp_filter }}
  notify: Apply sysctl

# Firewall Zone Assignment
- name: Ensure public interface is assigned to public zone
  ansible.posix.firewalld:
    zone: public
    interface: "{{ secure_public_if }}"
    permanent: yes
    state: enabled
    immediate: yes

- name: Ensure private interface is assigned to trusted zone
  ansible.posix.firewalld:
    zone: trusted
    interface: "{{ secure_trusted_if }}"
    permanent: yes
    state: enabled
    immediate: yes

# Trusted Zone Sources
- name: Trusted Zone - Allow Internal Networks
  ansible.posix.firewalld:
    zone: trusted
    source: "{{ item }}"
    permanent: yes
    state: enabled
    immediate: yes
  loop: "{{ secure_trusted_src }}"

# Public Zone Services & Masquerade
- name: Enable masquerade on public zone
  ansible.posix.firewalld:
    zone: public
    masquerade: yes
    permanent: yes
    state: enabled
    immediate: yes

- name: Open HTTP/HTTPS service on public zone
  ansible.posix.firewalld:
    zone: public
    service: "{{ item }}"
    permanent: yes
    state: enabled
    immediate: yes
  loop: [http, https]

# Cleanup Old Rules (Robustness)
- name: Remove wide NodePort forward range (30000-32767) if exists
  command: firewall-cmd --permanent --zone=public --remove-forward-port=port=30000-32767:proto=tcp:toaddr=10.2.2.2
  register: r_rm_np_range
  failed_when: false
  changed_when: "'success' in (r_rm_np_range.stdout | lower)"

- name: Reload firewalld if cleanup performed
  command: firewall-cmd --reload
  when: r_rm_np_range.changed

# Port Forwarding
- name: Add port forwarding rules
  ansible.posix.firewalld:
    zone: public
    port_forward:
      - port: "{{ item.port }}"
        proto: tcp
        toport: "{{ item.toport }}"
        toaddr: "{{ item.toaddr }}"
    permanent: yes
    state: enabled
    immediate: yes
  loop: "{{ secure_forward_ports }}"

---
# ═══════════════════════════════════════════════════════════════════════════
# Playbook 00: Network Provisioning - IP, Gateway, DNS 설정
# 설명: host_vars에 정의된 nicX_* 변수를 기반으로 정적 IP를 설정합니다.
# 주의: 실행 중 네트워크 연결이 끊길 수 있습니다. (설정이 현재와 다를 경우)
# ═══════════════════════════════════════════════════════════════════════════
# [Step 0] SSH Key Distribution (Keys must be distributed before connecting to nodes)
- name: SSH 키 자동 배포 (Script 실행)
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: SSH 배포 스크립트 실행
      shell: "bash Script/vm_distribute_ssh_ansible.sh"
      args:
        chdir: "{{ playbook_dir }}/../"
      register: script_result
      ignore_errors: yes


    - name: 스크립트 실행 결과 출력
      debug:
        msg: 
          - "STDOUT:"
          - "{{ script_result.stdout_lines }}"
          - "STDERR:"
          - "{{ script_result.stderr_lines }}"

# ═══════════════════════════════════════════════════════════════════════════
- name: 네트워크 인터페이스 프로비저닝
  hosts: All_Nodes
  become: yes
  serial: 2  # 한 번에 2대씩 진행하여 전체 중단 방지
  tasks:
    # [1단계] NIC 동적 감지 (서버의 실제 물리 인터페이스 찾기)
    # 설명: host_vars에 'eth0' 등으로 적혀 있어도, 실제 서버가 'ens160' 등을 쓸 수 있음.
    #       nmcli로 모든 이더넷 장치를 찾아내어 변수를 덮어씀.
    - name: 라이브 이더넷 인터페이스 목록 감지 (nmcli)
      shell: "nmcli -t -f DEVICE,TYPE device | grep 'ethernet' | cut -d: -f1"
      register: detected_nics
      changed_when: false
      ignore_errors: yes
      when: not ansible_check_mode

    - name: 감지된 인터페이스로 변수 갱신 (NIC 1 - 주 인터페이스)
      set_fact:
        nic1_interface: "{{ detected_nics.stdout_lines[0] }}"
      when: 
        - not ansible_check_mode
        - detected_nics.stdout_lines | length >= 1

    - name: 감지된 인터페이스로 변수 갱신 (NIC 2 - 보조 인터페이스)
      set_fact:
        nic2_interface: "{{ detected_nics.stdout_lines[1] }}"
      when: 
        - not ansible_check_mode
        - nic_count|default(0)|int >= 2 
        - detected_nics.stdout_lines | length >= 2

    - name: 감지된 인터페이스 확인
      debug:
        msg: 
          - "Found NICs: {{ detected_nics.stdout_lines }}"
          - "Applied NIC 1: {{ nic1_interface }}"
          - "Applied NIC 2: {{ nic2_interface | default('None') }}"
      when: not ansible_check_mode

    - name: NIC 1 설정 ({{ nic1_interface }})
      nmcli:
        conn_name: "{{ nic1_interface }}"
        ifname: "{{ nic1_interface }}"
        type: ethernet
        ip4: "{{ nic1_ip_address }}/24"
        gw4: "{{ nic1_gateway | default(omit) }}"
        dns4: "{{ nic1_dns | default(omit) }}"
        dns4_search: "{{ nic1_dns_search | default(omit) }}"
        method4: manual
        autoconnect: yes
        state: present
      when: 
        - not ansible_check_mode
        - nic_count|default(0)|int >= 1 
        - nic1_interface is defined

    # NIC 2 설정 (존재하는 경우)
    - name: NIC 2 설정 ({{ nic2_interface | default('none') }})
      nmcli:
        conn_name: "{{ nic2_interface }}"
        ifname: "{{ nic2_interface }}"
        type: ethernet
        ip4: "{{ nic2_ip_address }}/24"
        gw4: "{{ nic2_gateway | default(omit) }}"
        dns4: "{{ nic2_dns | default(omit) }}"
        dns4_search: "{{ nic2_dns_search | default(omit) }}"
        method4: manual
        autoconnect: yes
        state: present
      when: 
        - not ansible_check_mode
        - nic_count|default(0)|int >= 2 
        - nic2_interface is defined

    - name: 연결 다시 로드 (NetworkManager)
      shell: nmcli connection reload
      ignore_errors: yes
      when: not ansible_check_mode

    - name: 새 연결 활성화 ({{ nic1_interface }})
      shell: "nmcli connection up {{ nic1_interface }}"
      ignore_errors: yes
      async: 45
      poll: 0
      when: not ansible_check_mode

    - name: 잠시 대기 (네트워크 안정화)
      pause:
        seconds: 10
      when: not ansible_check_mode

    - name: 구식 연결 정리 (eth0, eth1 등 최종 제거)
      shell: |
        TARGET_IF="{{ nic1_interface }}"
        
        echo "=== Final cleanup: removing old connections for $TARGET_IF ==="
        
        # 현재 활성 연결 확인
        ACTIVE_CONN=$(nmcli -t -f NAME,DEVICE connection show --active | grep ":$TARGET_IF$" | cut -d: -f1)
        
        # 이 인터페이스와 연결된 모든 connection 찾기 (활성/비활성 모두)
        # connection.interface-name으로 찾아야 비활성 연결도 검색됨
        ALL_CONNS=$(nmcli -t -f NAME,DEVICE connection show | awk -F: '{print $1}' | while read conn; do
            IFACE=$(nmcli -t -f connection.interface-name connection show "$conn" 2>/dev/null | cut -d: -f2)
            if [ "$IFACE" = "$TARGET_IF" ]; then
                echo "$conn"
            fi
        done)
        
        # 목표 이름이 아닌 모든 연결 삭제
        for conn in $ALL_CONNS; do
            # 현재 활성 연결은 건드리지 않음 (SSH 보호)
            if [ "$conn" = "$ACTIVE_CONN" ]; then
                echo "Keeping active connection: $conn"
                continue
            fi
            
            # 목표 이름(ens160)이 아닌 연결 삭제
            if [ "$conn" != "$TARGET_IF" ]; then
                echo "Removing old connection: $conn"
                nmcli connection delete "$conn" 2>/dev/null || true
            fi
        done
        
        echo "=== Cleanup complete ==="
      ignore_errors: yes
      when: 
        - not ansible_check_mode
        - nic1_interface is defined

    - name: NIC 2 구식 연결 정리 (존재하는 경우)
      shell: |
        TARGET_IF="{{ nic2_interface }}"
        
        echo "=== Final cleanup: removing old connections for $TARGET_IF ==="
        
        ACTIVE_CONN=$(nmcli -t -f NAME,DEVICE connection show --active | grep ":$TARGET_IF$" | cut -d: -f1)
        
        # 이 인터페이스와 연결된 모든 connection 찾기
        ALL_CONNS=$(nmcli -t -f NAME,DEVICE connection show | awk -F: '{print $1}' | while read conn; do
            IFACE=$(nmcli -t -f connection.interface-name connection show "$conn" 2>/dev/null | cut -d: -f2)
            if [ "$IFACE" = "$TARGET_IF" ]; then
                echo "$conn"
            fi
        done)
        
        for conn in $ALL_CONNS; do
            if [ "$conn" = "$ACTIVE_CONN" ] || [ "$conn" = "$TARGET_IF" ]; then
                continue
            fi
            
            echo "Removing old connection: $conn"
            nmcli connection delete "$conn" 2>/dev/null || true
        done
        
        echo "=== Cleanup complete ==="
      ignore_errors: yes
      when: 
        - not ansible_check_mode
        - nic_count|default(0)|int >= 2
        - nic2_interface is defined

- name: 외부 통신 설정 (Bridge Network - PC1)
  hosts: Security_Tier
  become: yes
  tasks:
    - name: 외부 DNS 설정
      lineinfile:
        path: /etc/resolv.conf
        line: "nameserver 8.8.8.8"
      tags: network

- name: 내부 통신 설정 (HostOnly Network - PC2~6)
  hosts: PC2:PC3:PC4:PC5:PC6
  become: yes
  tasks:
    - name: 내부 통신 확인
      ping:
      tags: network

# (제거됨: PC1 추가 설정은 roles/secure, roles/waf, roles/dns에서 처리합니다)
# π³ Jenkins λ°°ν¬ κ°€μ΄λ“ (All-Ansible ν™μ©)

λ³Έ λ¬Έμ„λ” **Antigravity** ν”„λ΅μ νΈμ `All-Ansible` μ €μ¥μ†λ¥Ό ν™μ©ν•μ—¬ **Jenkins**λ¥Ό ν¬ν•¨ν• CI/CD ν™κ²½μ„ κµ¬μ¶•ν•λ” λ°©λ²•μ„ μ„¤λ…ν•©λ‹λ‹¤.

---

## π“‹ 1. μ‚¬μ „ μ”κµ¬μ‚¬ν•­ (Prerequisites)

### 1.1 μ €μ¥μ† (Repository)
- **μ£Όμ†**: `http://10.2.2.40:3001/admin/All-Ansible`
- **λ©μ **: μΈν”„λΌ λ°°ν¬λ¥Ό μ„ν• λ¨λ“  Ansible μ½”λ“ ν¬ν•¨

### 1.2 μ‹¤ν–‰ ν™κ²½ (Control Node)
- Ansibleμ΄ μ„¤μΉλ λ¦¬λ…μ¤ λ¨Έμ‹  (λ³΄ν†µ κ°λ°μ PC λλ” λ³„λ„μ κ΄€λ¦¬μ© μ„λ²„)
- SSH μ ‘μ†μ΄ κ°€λ¥ν•΄μ•Ό ν•¨ (SSH ν‚¤ λ°°ν¬ μ™„λ£ μƒνƒ κ¶μ¥)

---

## π€ 2. μ„¤μΉ μ μ°¨ (Installation Steps)

### λ‹¨κ³„ 1: μ½”λ“ κ°€μ Έμ¤κΈ° (Clone)
κ°€μ¥ μµμ‹ μ μΈν”„λΌ μ½”λ“λ¥Ό λ‚΄λ ¤λ°›μµλ‹λ‹¤.

```bash
# 1. μ‘μ—… λ””λ ‰ν† λ¦¬ μƒμ„±
mkdir -p ~/workspace && cd ~/workspace

# 2. μ €μ¥μ† λ³µμ  (Gitea κ³„μ • ν•„μ”)
git clone http://10.2.2.40:3001/admin/All-Ansible.git

# 3. λ””λ ‰ν† λ¦¬ μ΄λ™
cd All-Ansible
```

### λ‹¨κ³„ 2: μΈλ²¤ν† λ¦¬ ν™•μΈ
λ°°ν¬ λ€μƒ μ„λ²„(`CI-OPS`, `PC5`)κ°€ μΈλ²¤ν† λ¦¬μ— μ¬λ°”λ¥΄κ² μ •μλμ–΄ μλ”μ§€ ν™•μΈν•©λ‹λ‹¤.

```bash
# μΈλ²¤ν† λ¦¬ νμΌ: inventory.ini
cat inventory.ini | grep CI-OPS -A 5
```

### λ‹¨κ³„ 3: λ°°ν¬ μ‹¤ν–‰ (Ansible Playbook)
Jenkins λ° Gitea λ°°ν¬λ¥Ό λ‹΄λ‹Ήν•λ” `05_deploy_cicd.yml` ν”λ μ΄λ¶μ„ μ‹¤ν–‰ν•©λ‹λ‹¤.

```bash
# μµμ… μ„¤λ…:
# -i inventory.ini : μ„λ²„ λ©λ΅ νμΌ μ§€μ •
# playbooks/05_deploy_cicd.yml : μ‹¤ν–‰ν•  ν”λ μ΄λ¶
# -u ansible : (κ¶μ¥) ansible κ³„μ • μ‚¬μ© (bootstrpμ΄ μ™„λ£λ κ²½μ°)

ansible-playbook -i inventory.ini playbooks/05_deploy_cicd.yml
```

> **μ°Έκ³ **: λ§μ•½ μ΄κΈ° μ„¤μ •μ΄λΌ `ansible` κ³„μ •μ΄ μ—†λ‹¤λ©΄ `-u root` μµμ…μ„ μ‚¬μ©ν•μ„Έμ”.

### λ‹¨κ³„ 4: Jenkins SSH ν‚¤ λ°°ν¬ (ν•„μ! β οΈ)
Jenkins μ»¨ν…μ΄λ„κ°€ λ‹¤λ¥Έ μ„λ²„λ“¤μ— μ ‘μ†ν•μ—¬ Ansibleμ„ μ‹¤ν–‰ν•λ ¤λ©΄, Jenkinsμ SSH ν‚¤κ°€ λ¨λ“  μ„λ²„μ— λ“±λ΅λμ–΄ μμ–΄μ•Ό ν•©λ‹λ‹¤. μ΄ μ‘μ—…μ€ **μµμ΄ 1ν** ν•„μμ…λ‹λ‹¤.

```bash
# Jenkins μ»¨ν…μ΄λ„μ ν‚¤λ¥Ό λ¨λ“  μ„λ²„μ— λ°°ν¬
ansible-playbook -i inventory.ini playbooks/05_configure_jenkins_ssh.yml
```

---

## β… 3. μ ‘μ† λ° κ²€μ¦ (Verification)

λ°°ν¬κ°€ μ™„λ£λλ©΄ μ•„λ μ£Όμ†λ΅ μ ‘μ†ν•μ—¬ μ •μƒ λ™μ‘μ„ ν™•μΈν•©λ‹λ‹¤.

### π Jenkins μ ‘μ†
- **URL**: `http://172.16.6.61:8080` (μ™Έλ¶€ Gateway ν¬νΈν¬μ›λ”©)
- **λ‚΄λ¶€λ§ URL**: `http://10.2.2.40:8080`
- **μ΄κΈ° κ³„μ •**: (ν”λ μ΄λ¶/Role μ„¤μ •μ— λ”°λΌ λ‹¤λ¦„, λ³΄ν†µ `admin`)
- **μ΄κΈ° λΉ„λ°€λ²νΈ ν™•μΈ**:
  ```bash
  # Jenkins μ„λ²„(PC5)μ—μ„ ν™•μΈ
  sudo cat /var/lib/jenkins/secrets/initialAdminPassword
  ```

### πµ Gitea μ ‘μ†
- **URL**: `http://172.16.6.61:3001`
- **λ‚΄λ¶€λ§ URL**: `http://10.2.2.40:3001`

---

## π› οΈ 4. λ¬Έμ  ν•΄κ²° (Troubleshooting)

**Q. λ°°ν¬ μ¤‘ "Permission denied" μ—λ¬κ°€ λ‚©λ‹λ‹¤.**
A. SSH μ ‘κ·Ό κ¶ν• λ¬Έμ μ…λ‹λ‹¤. `ansible` κ³„μ •μ SSH ν‚¤κ°€ λ€μƒ μ„λ²„(PC5)μ— λ°°ν¬λμ–΄ μλ”μ§€ ν™•μΈν•μ„Έμ”.
   ```bash
   ssh ansible@10.2.2.40
   ```

**Q. μ™Έλ¶€(172.16.6.x)μ—μ„ μ ‘μ†μ΄ μ• λ©λ‹λ‹¤.**
A. Gateway(SECURE, 172.16.6.61)μ λ°©ν™”λ²½ ν¬νΈν¬μ›λ”©μ΄ μ λ€λ΅ μ μ©λμ—λ”μ§€ ν™•μΈν•μ„Έμ”.
   ```bash
   # Gateway μ„λ²„μ—μ„ μ‹¤ν–‰
   sudo firewall-cmd --list-all --zone=public
   ```
   `8080` ν¬νΈ ν¬μ›λ”©(`10.2.2.40:8080`μΌλ΅ μ—°κ²°)μ΄ λ³΄μ—¬μ•Ό ν•©λ‹λ‹¤.

---

## π’» 5. μ›Ή μ½μ†”(Web Console)λ΅ μ‹¤ν–‰ν•λ” λ²• (Jenkins Pipeline)

"ν„°λ―Έλ„ λ§κ³  μ›Ήμ—μ„ λ²„νΌ ν΄λ¦­μΌλ΅ λ°°ν¬ν•κ³  μ‹¶μ–΄μ”!"

μ΄λ―Έ Jenkinsκ°€ μ„¤μΉλμ–΄ μλ‹¤λ©΄, μ΄ μ €μ¥μ†(`All-Ansible`)λ¥Ό Jenkins νμ΄ν”„λΌμΈμΌλ΅ λ“±λ΅ν•μ—¬ **μ›Ή μ½μ†”**μ—μ„ Ansibleμ„ μ‹¤ν–‰ν•  μ μμµλ‹λ‹¤.

### 5.1 μƒλ΅μ΄ νμ΄ν”„λΌμΈ μƒμ„±
1. **Jenkins μ ‘μ†** (`http://172.16.6.61:8080`)
2. **Dashboard** > **New Item** ν΄λ¦­
3. μ΄λ¦„ μ…λ ¥ (μ: `Infrastructure-Deploy`) -> **Pipeline** μ„ νƒ -> **OK**

### 5.2 νμ΄ν”„λΌμΈ μ„¤μ •
1. **Definition**: `Pipeline script from SCM` μ„ νƒ
2. **SCM**: `Git` μ„ νƒ
3. **Repository URL**: `http://10.2.2.40:3001/admin/All-Ansible.git`
4. **Branches to build**: `*/main`
5. **Script Path**: `Jenkinsfile` (μ €μ¥μ† λ£¨νΈμ— μ΄λ―Έ λ§λ“¤μ–΄ λ‘μ—μµλ‹λ‹¤!)
6. **Save** ν΄λ¦­

### 5.3 μ‹¤ν–‰ ν•κΈ° (Build with Parameters)
1. μƒμ„±λ νμ΄ν”„λΌμΈ μ ‘μ†
2. **Build with Parameters** ν΄λ¦­
3. **PLAYBOOK**: μ‹¤ν–‰ν•κ³  μ‹¶μ€ ν”λ μ΄λ¶ μ„ νƒ (μ: `site.yml`)
4. **LIMIT**: (μ„ νƒ) νΉμ • μ„λ²„λ§ λ€μƒ μ§€μ •ν•κ±°λ‚ μ μ™Έν•  λ• μ‚¬μ© (κΈ°λ³Έκ°’: `all`)
   - μ: DB μ„λ²„ μ μ™Έν•κΈ° -> `!PC4` λλ” `!DB_Servers`
5. **DRY_RUN**: μ²΄ν¬ν•λ©΄ κ°€μƒ μ‹¤ν–‰(μ‹λ®¬λ μ΄μ…)λ§ μν–‰
6. **Build** λ²„νΌ ν΄λ¦­

μ΄μ  ν„°λ―Έλ„ μ—†μ΄λ„ μ›Ή λΈλΌμ°μ €μ—μ„ μΈν”„λΌλ¥Ό λ°°ν¬ν•κ³  κ²°κ³Όλ¥Ό ν™•μΈν•  μ μμµλ‹λ‹¤! π‰

---
# roles/common/tasks/main.yml

# 1. SELinux & Firewall
- name: 1. SELinux 비활성화
  selinux:
    state: disabled

- name: 1.5. firewalld 서비스 시작
  service:
    name: firewalld
    state: started
    enabled: yes

- name: 2. 방화벽(firewalld) 필요한 포트 열기
  firewalld:
    service: "{{ item }}"
    permanent: true
    immediate: true
    state: enabled
  with_items:
    - ssh
    - https

- name: 3. 방화벽에서 ICMP (ping) 허용
  firewalld:
    protocol: icmp
    permanent: true
    immediate: true
    state: enabled

- name: 4. 방화벽 재시작
  command: firewall-cmd --reload

# 2. Basic Configuration (Hosts, Utils)
- name: 5. 모든 서버에 /etc/hosts 매핑 (Ansible Inventory 기준)
  template:
    src: hosts.j2
    dest: /etc/hosts
    mode: '0644'

- name: 6. 필수 유틸리티 설치
  dnf:
    name: [vim, wget, curl, net-tools]
    state: present

# 3. Hostname & Prompt Customization
- name: 호스트네임 Prefix 결정 (Tier 감지)
  set_fact:
    tier_prefix: >-
      {%- if inventory_hostname in ['SECURE', 'WAF'] -%}PC1
      {%- elif 'ControlPlane' in inventory_hostname -%}PC2
      {%- elif inventory_hostname in ['K8S-WorkerNode1', 'K8S-WorkerNode2', 'K8S-WorkerNode3'] -%}PC3
      {%- elif 'DB' in inventory_hostname or 'Storage' in inventory_hostname or 'etcd' in inventory_hostname -%}PC4
      {%- elif inventory_hostname in ['CICD-OPS', 'DNS'] or 'Monitoring' in inventory_hostname -%}PC5
      {%- elif inventory_hostname in ['K8S-WorkerNode4', 'K8S-WorkerNode5', 'K8S-WorkerNode6'] -%}PC6
      {%- else -%}PCX{%- endif -%}

- name: "호스트네임 설정 (ex: PC1-SECURE)"
  hostname:
    name: "{{ tier_prefix }}-{{ inventory_hostname | replace('_', '-') }}"

- name: Prompt 색상 계산 (Host별 Round-Robin)
  set_fact:
    prompt_color: "{{ 91 + (groups['All_Nodes'].index(inventory_hostname) % 6) }}"

- name: 기존 Bash 프롬프트 설정 제거 (root)
  replace:
    path: /root/.bashrc
    regexp: '^(\s*)(export\s+)?PS1=.*'
    replace: ''
  ignore_errors: yes

- name: Bash 프롬프트 색상 설정 (root)
  blockinfile:
    path: /root/.bashrc
    marker: "# {mark} ANSIBLE MANAGED PROMPT COLOR"
    content: |
      # Host-based Unique Prompt Color
      export PS1="\[\e[{{ prompt_color }};1m\][\u@\h\[\e[33;1m\] \w]\$ \[\e[m\]"
      alias c='clear'
      alias rm='rm -i'
      alias cp='cp -i'
      alias mv='mv -i'

- name: 기존 Bash 프롬프트 설정 제거 (ansible)
  replace:
    path: /home/ansible/.bashrc
    regexp: '^(\s*)(export\s+)?PS1=.*'
    replace: ''
  ignore_errors: yes

- name: Bash 프롬프트 색상 설정 (ansible)
  blockinfile:
    path: /home/ansible/.bashrc
    marker: "# {mark} ANSIBLE MANAGED PROMPT COLOR"
    content: |
      # Host-based Unique Prompt Color
      export PS1="\[\e[{{ prompt_color }};1m\][\u@\h\[\e[33;1m\] \w]\$ \[\e[m\]"
      alias c='clear'
      alias rm='rm -i'
      alias cp='cp -i'
      alias mv='mv -i'

# 4. GUI & Desktop Environment Setup
- name: Chrome 설치 여부 확인
  command: which google-chrome-stable
  register: chrome_installed
  changed_when: false
  failed_when: false
  ignore_errors: yes

- name: Google Chrome RPM 다운로드
  get_url:
    url: https://dl.google.com/linux/direct/google-chrome-stable_current_x86_64.rpm
    dest: /tmp/google-chrome-stable.rpm
    mode: '0644'
  when: chrome_installed.rc != 0
  ignore_errors: yes

- name: Chrome RPM 설치
  dnf:
    name: /tmp/google-chrome-stable.rpm
    state: present
    disable_gpg_check: yes
  when: chrome_installed.rc != 0
  ignore_errors: yes

- name: Chrome RPM 파일 삭제
  file:
    path: /tmp/google-chrome-stable.rpm
    state: absent
  when: chrome_installed.rc != 0
  ignore_errors: yes

- name: VS Code 설치 여부 확인
  command: which code
  register: vscode_installed
  changed_when: false
  failed_when: false
  ignore_errors: yes

- name: Microsoft GPG Key 가져오기
  rpm_key:
    state: present
    key: https://packages.microsoft.com/keys/microsoft.asc
  when: vscode_installed.rc != 0
  ignore_errors: yes

- name: VS Code Repo 추가
  copy:
    dest: /etc/yum.repos.d/vscode.repo
    content: |
      [code]
      name=Visual Studio Code
      baseurl=https://packages.microsoft.com/yumrepos/vscode
      enabled=1
      gpgcheck=1
      gpgkey=https://packages.microsoft.com/keys/microsoft.asc
  when: vscode_installed.rc != 0
  ignore_errors: yes

- name: DNF 캐시 갱신 (VS Code Repo)
  command: dnf makecache --disablerepo=* --enablerepo=code
  changed_when: false
  when: vscode_installed.rc != 0
  ignore_errors: yes

- name: VS Code 설치
  dnf:
    name: code
    state: present
  when: vscode_installed.rc != 0
  ignore_errors: yes

- name: Antigravity 설치 여부 확인
  command: which antigravity
  register: antigravity_installed
  changed_when: false
  failed_when: false
  ignore_errors: yes

- name: Antigravity RPM Repository 추가
  copy:
    dest: /etc/yum.repos.d/antigravity.repo
    content: |
      [antigravity-rpm]
      name=Antigravity RPM Repository
      baseurl=https://us-central1-yum.pkg.dev/projects/antigravity-auto-updater-dev/antigravity-rpm
      enabled=1
      gpgcheck=0
  when: antigravity_installed.rc != 0
  ignore_errors: yes

- name: DNF 캐시 갱신 (Antigravity Repo)
  command: dnf makecache
  changed_when: false
  when: antigravity_installed.rc != 0
  ignore_errors: yes

- name: Antigravity 패키지 설치
  dnf:
    name: antigravity
    state: present
  when: antigravity_installed.rc != 0
  ignore_errors: yes

- name: GNOME 확장 및 트윅 도구 설치
  dnf:
    name: 
      - gnome-extensions-app
      - gnome-tweaks
      - dconf-editor
      - gnome-shell-extension-desktop-icons
    state: present
  ignore_errors: yes

- name: 현재 기본 타겟 확인
  command: systemctl get-default
  register: current_target
  changed_when: false
  ignore_errors: yes

- name: GUI 모드로 기본 타겟 설정 (graphical.target)
  command: systemctl set-default graphical.target
  when: current_target.stdout != "graphical.target"
  ignore_errors: yes

- name: root 바탕화면 디렉토리 경로 감지
  shell: "su - root -c 'xdg-user-dir DESKTOP' 2>/dev/null || echo /root/Desktop"
  register: root_desktop_dir
  changed_when: false
  ignore_errors: yes

- name: root 바탕화면 디렉토리 생성
  file:
    path: "{{ root_desktop_dir.stdout }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  ignore_errors: yes

- name: ansible 바탕화면 디렉토리 경로 감지
  shell: "su - ansible -c 'xdg-user-dir DESKTOP' 2>/dev/null || echo /home/ansible/Desktop"
  register: ansible_desktop_dir
  changed_when: false
  ignore_errors: yes

- name: ansible 바탕화면 디렉토리 생성
  file:
    path: "{{ ansible_desktop_dir.stdout }}"
    state: directory
    owner: ansible
    group: ansible
    mode: '0755'
  ignore_errors: yes

- name: Desktop Setup Fact 정의
  set_fact:
    desktop_users:
      - user: root
        group: root
        home: /root
        desktop: "{{ root_desktop_dir.stdout }}"
        data_suffix: "-root"
      - user: ansible
        group: ansible
        home: /home/ansible
        desktop: "{{ ansible_desktop_dir.stdout }}"
        data_suffix: ""

- name: Antigravity 바로가기 아이콘 생성 (통합 Loop)
  copy:
    dest: "{{ item.desktop }}/Antigravity.desktop"
    content: |
      [Desktop Entry]
      Name=Antigravity
      Comment=Experience liftoff
      GenericName=Text Editor
      Exec=/usr/share/antigravity/antigravity --user-data-dir={{ item.home }}/.antigravity{{ item.data_suffix }} --no-sandbox --disable-gpu-sandbox %F
      Icon=antigravity
      Type=Application
      StartupNotify=false
      StartupWMClass=Antigravity
      Categories=TextEditor;Development;IDE;
      MimeType=application/x-antigravity-workspace;
      Actions=new-empty-window;
      Keywords=vscode;

      [Desktop Action new-empty-window]
      Name=New Empty Window
      Name[ko]=새 빈 창
      Exec=/usr/share/antigravity/antigravity --user-data-dir={{ item.home }}/.antigravity{{ item.data_suffix }} --no-sandbox --disable-gpu-sandbox --new-window %F
      Icon=antigravity
    owner: "{{ item.user }}"
    group: "{{ item.group }}"
    mode: '0755'
  loop: "{{ desktop_users }}"
  ignore_errors: yes

- name: Google Chrome 바로가기 아이콘 생성 (통합 Loop)
  copy:
    dest: "{{ item.desktop }}/google-chrome.desktop"
    content: |
      [Desktop Entry]
      Version=1.0
      Name=Google Chrome
      GenericName=Web Browser
      Comment=Access the Internet
      Exec=/usr/bin/google-chrome-stable --no-sandbox %U
      StartupNotify=true
      Terminal=false
      Icon=google-chrome
      Type=Application
      Categories=Network;WebBrowser;
    owner: "{{ item.user }}"
    group: "{{ item.group }}"
    mode: '0755'
  loop: "{{ desktop_users }}"
  ignore_errors: yes

- name: VS Code 바로가기 아이콘 생성 (통합 Loop)
  copy:
    dest: "{{ item.desktop }}/code.desktop"
    content: |
      [Desktop Entry]
      Name=Visual Studio Code
      Comment=Code Editing. Redefined.
      GenericName=Text Editor
      Exec=/usr/share/code/code --user-data-dir={{ item.home }}/.vscode{{ item.data_suffix }} --no-sandbox --disable-gpu-sandbox %F
      Icon=vscode
      Type=Application
      StartupNotify=false
      Categories=TextEditor;Development;IDE;
    owner: "{{ item.user }}"
    group: "{{ item.group }}"
    mode: '0755'
  loop: "{{ desktop_users }}"
  ignore_errors: yes

- name: Terminal 바로가기 아이콘 생성 (통합 Loop)
  copy:
    dest: "{{ item.desktop }}/Terminal.desktop"
    content: |
      [Desktop Entry]
      Name=Terminal
      Comment=Open Terminal
      GenericName=Terminal
      Exec=gnome-terminal
      Icon=utilities-terminal
      Type=Application
      StartupNotify=true
      Categories=System;TerminalEmulator;
    owner: "{{ item.user }}"
    group: "{{ item.group }}"
    mode: '0755'
  loop: "{{ desktop_users }}"
  ignore_errors: yes

- name: 바탕화면 아이콘 신뢰 설정 (통합)
  shell: |
    for desktop_file in {{ item.desktop }}/*.desktop; do
      if [ -f "$desktop_file" ]; then
        gio set "$desktop_file" metadata::trusted true 2>/dev/null || true
        chmod +x "$desktop_file"
      fi
    done
  become_user: "{{ item.user }}"
  loop: "{{ desktop_users }}"
  ignore_errors: yes